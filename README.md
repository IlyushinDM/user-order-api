# REST API на Go

Этот репозиторий содержит пример REST API, написанный на Go. API предоставляет функциональность для управления пользователями и заказами.

## Доступ к API

API будет доступно по адресу `http://localhost:8080` (или порт, указанный в `.env`).

Документация Swagger будет доступна по адресу `http://localhost:8080/swagger/index.html`.

## Структура проекта

Проект организован в соответствии с рекомендациями Go Standard Project Layout:
```bash
project/
├── cmd/                 # Точки входа для запуска приложений
│   ├── main.go          # Основная точка входа (HTTP сервер)
│   └── main_test.go
├── docs/                # Файлы документации API (Swagger)
│   ├── docs.go
│   ├── swagger.json
│   └── swagger.yaml
├── internal/            # Приватный код приложения (не предназначен для использования другими проектами)
│   ├── core/            # Основная инициализация приложения и роутинг
│   │   ├── app_core.go
│   │   └── router_core.go
│   ├── handlers/        # Обработчики HTTP-запросов
│   │   ├── common_handler/
│   │   ├── order_handler/
│   │   └── user_handler/
│   ├── models/          # Структуры данных, представляющие сущности БД
│   │   ├── order_model/
│   │   └── user_model/
│   ├── repository/      # Логика взаимодействия с базой данных
│   │   ├── database/
│   │   ├── order_rep/
│   │   └── user_rep/
│   ├── services/        # Бизнес-логика приложения
│   │   ├── order_service/
│   │   └── user_service/
│   ├── middleware/      # HTTP Middleware
│   │   ├── auth_middleware/
│   │   └── logger_middleware/
│   └── utils/           # Вспомогательные утилиты и хелперы
│       ├── config_util/ # Утилита для загрузки конфигурации
│       ├── jwt_util/    # Утилита для работы с JWT
│       ├── logger_util/ # Утилита для логирования
│       └── password_util/# Утилита для работы с паролями
├── migrations/          # Скрипты миграции базы данных (SQL)
│   ├── 001_users_table.up.sql
│   ├── 001_users_table.down.sql
│   ├── 002_orders_table.up.sql
│   └── 002_orders_table.down.sql
├── .dockerignore        # Исключения для Docker
├── .gitignore           # Исключения для Git
├── go.mod               # Модуль Go и зависимости
├── go.sum               # Контрольные суммы зависимостей
├── .env                 # Переменные окружения для локальной разработки/настройки
├── Dockerfile           # Определение Docker-образа
├── docker-compose.yml   # Определение сервисов для Docker Compose
├── app_up.sh            # Скипт для подготовки и сборки (если не используется Docker)
└── README.md            # Этот файл :)
```

## Описание компонентов

*   **Модели данных:** Добавлена модель `Order` и связанные структуры запросов/ответов. Все модели содержат аннотации для автоматической генерации документации Swagger.
*   **Репозиторий:** Созданы интерфейсы и их реализации для абстрагирования работы с GORM. Добавлено логирование операций. Методы для работы с заказами учитывают `UserID`.
*   **Сервисы:** Добавлены `UserService` и `OrderService` для реализации бизнес-логики, включая валидацию, хеширование паролей, генерацию JWT и проверку прав доступа.
*   **Обработчики (Handlers):** Обработчики зависят от сервисов, а не напрямую от GORM. Реализована обработка ошибок, интеграция Swagger-аннотаций. Добавлены `AuthHandler` и `OrderHandler`. Общие функции вынесены в `common_handler.go`.
*   **Middleware:** Добавлены `AuthMiddleware` для проверки JWT и `LoggerMiddleware` для логирования запросов.
*   **JWT:** Реализована генерация и валидация JWT токенов.
*   **Логирование:** `logrus` используется для структурированного логирования во всех слоях. GORM также настроен на использование `logrus`. Для логирования настроена асинхронная обработка данных.
*   **Swagger:** Аннотации godoc используются для автоматической генерации документации. UI Swagger доступен по адресу `/swagger/index.html`.
*   **Docker:** Предоставлены `Dockerfile` и `docker-compose.yml` для удобного запуска в контейнерах.
*   **Асинхронность:** Асинхронная обработка данных реализована для логирования путем буферизации лог-сообщений в канале и их последующей записи в фоновой горутине. Это позволяет не блокировать основной поток программы на операциях ввода/вывода при логировании.

## Переменные в файле .env

Приложение требует следующие переменные окружения, которые должны быть указаны в файле `.env` в корне проекта:
```bash
# Настройки подключения к базе данных
DB_HOST=localhost # как пример
DB_PORT=5432 # как пример
DB_NAME=users_orders_db # как пример
DB_USER=postgres # как пример
DB_PASSWORD=******

# Настройки пула подключений к базе данных
DB_MAX_IDLE_CONNS=10
DB_MAX_OPEN_CONNS=100
DB_CONN_MAX_LIFETIME=1h
DB_CONN_MAX_IDLE_TIME=30m

# Общие настройки приложения
PORT=8080
GIN_MODE=release # production или debug
LOG_LEVEL=info # Уровень логирования (panic, fatal, error, warn, info, debug, trace)

# Настройка JWT
JWT_SECRET=******** # Секретный ключ для подписи JWT
JWT_EXPIRATION=1h # Время жизни токена (например: 24h, 3600s)

# Среда приложения (prod или dev)
APP_ENV=prod

# Настройки HTTP сервера
HTTP_READ_TIMEOUT=5 # Таймаут на чтение запроса в секундах
HTTP_WRITE_TIMEOUT=10 # Таймаут на запись ответа в секундах
HTTP_IDLE_TIMEOUT=60 # Таймаут для поддержания Keep-Alive соединений в секундах
HTTP_MAX_HEADER_BYTES=1048576 # Максимальный размер заголовков запроса в байтах (1MB)

# Настройка таймаута для Graceful Shutdown
SHUTDOWN_TIMEOUT=15s # Максимальное время ожидания завершения активных запросов при остановке сервера
```

## Начало Работы

### Предварительные Требования

*   Go (версия 1.18 или выше)
*   Docker и Docker Compose (рекомендуется для локальной базы данных и запуска в контейнерах)
*   PostgreSQL (если не используете Docker Compose)

### Настройка

1.  **Клонируйте репозиторий:**

```bash
git clone <URL репозитория>
cd project
```

2.  **Настройте переменные окружения:**
    Создайте файл `.env` в корне проекта. Скопируйте содержимое из примера выше и заполните необходимые данные.

3.  **Настройка базы данных:**
    ***Используя Docker Compose (рекомендуется):***
    Запустите контейнер базы данных и выполните миграции:
```bash
docker-compose up -d db
# Подождите немного, пока база данных запустится
# Выполните миграции (необходимо установить инструмент для миграций, например, migrate)
migrate -path migrations -database "postgresql://DB_USER:DB_PASSWORD@DB_HOST:DB_PORT/DB_NAME?sslmode=disable" up
# Замените DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_NAME на значения из .env
```
*Примечание:* Для выполнения миграций может потребоваться установка дополнительного инструмента, например, `migrate` от golang-migrate/migrate. Инструкции по его установке и использованию можно найти в официальной документации инструмента.

***Вручную:***
    Установите и настройте PostgreSQL локально. Создайте базу данных с именем, указанным в `.env`. Выполните SQL-скрипты из директории `migrations/` в правильном порядке (`.up.sql`).

## Запуск Приложения

Проект предоставляет несколько способов запуска приложения. Убедитесь, что вы выполнили шаги по [Настройке](#настройка) и [Настройке базы данных](#настройка-базы-данных) перед запуском.

### Использование Docker Compose (Рекомендуется)

Этот метод запускает приложение и базу данных в контейнерах Docker.
```bash
docker-compose up --build
```
Приложение будет доступно по адресу `http://localhost:8080` (или порту, указанному в `.env`).

### Запуск из исходников Go

Этот метод запускает приложение напрямую из исходного кода Go. Убедитесь, что у вас установлен Go и настроена база данных.
```bash
go run cmd/main.go
```
Приложение также будет доступно по адресу `http://localhost:8080` (или порту, указанному в `.env`).

### Запуск с помощью исполняемого файла (через скрипт `app_up.sh`)

Вы можете собрать исполняемый файл приложения и запустить его. Этот метод может быть полезен для развертывания или тестирования собранного артефакта.

1.  Сделайте скрипт исполняемым:
```bash
chmod +x app_up.sh
```
*Примечание:* Эта команда используется в Unix-подобных системах.

2.  Запустите скрипт:
```bash
./app_up.sh
```

Приложение будет доступно по адресу `http://localhost:8080` (или порту, указанному в `.env`).

*Примечание:* Перед запуском этим способом убедитесь, что все необходимые переменные окружения доступны для исполняемого файла (например, загружены из `.env` скриптом или установлены в окружении системы).

## Конфигурация

Приложение использует переменные окружения для конфигурации. Основные переменные описаны в секции [.env](#переменные-в-файле-env). Утилита `internal/utils/config_util` загружает и парсит эти переменные при запуске.

## Документация API

Документация API доступна в формате Swagger.
При локальном запуске сервера документация доступна по адресу: `http://localhost:<PORT>/swagger/index.html`.
(Замените `<PORT>` на порт, указанный в вашем файле `.env`).

Файлы Swagger (`swagger.json`, `swagger.yaml`) генерируются автоматически с использованием комментариев в коде (`// @...`). Для генерации документации может потребоваться установка и запуск инструмента Swag:
```bash
go install github.com/swaggo/swag/cmd/swag@latest
swag init -g cmd/main.go
```
## Тестирование

В проекте предусмотрены модульные тесты для различных компонентов, расположенные в файлах с суффиксом `_test.go`.
Для запуска всех тестов выполните команду в корне проекта:
```bash
go test ./...

# Для запуска тестов в конкретной директории:
go test ./internal/services/user_service
```

## Зависимости

Управление зависимостями осуществляется с помощью Go Modules. Зависимости перечислены в файле `go.mod`.
Для загрузки или обновления зависимостей используйте стандартные команды Go:
```bash
go mod tidy # Добавляет недостающие и удаляет неиспользуемые зависимости
go get <пакет> # Добавляет или обновляет конкретный пакет
```
